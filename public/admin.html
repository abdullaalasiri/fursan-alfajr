<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ÙØ±Ø³Ø§Ù† Ø§Ù„ÙØ¬Ø± - Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFB88C 0%, #E8A0BF 15%, #C8B6E2 35%, #9D84B7 60%, #5B6FA8 85%, #2C3E7C 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(44, 62, 124, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .header h1 { 
            background: linear-gradient(135deg, #FFB88C, #E8A0BF, #9D84B7, #2C3E7C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 24px;
            font-weight: bold;
        }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .admin-badge {
            background: linear-gradient(135deg, #FFB88C, #E8A0BF);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(255, 184, 140, 0.3);
        }
        .logout-btn {
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(44, 62, 124, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .number { 
            background: linear-gradient(135deg, #9D84B7, #5B6FA8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 36px; 
            font-weight: bold;
        }
        .table-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(44, 62, 124, 0.15);
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .table-card h2 { 
            background: linear-gradient(135deg, #9D84B7, #5B6FA8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px; 
            text-align: center;
            font-weight: bold;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { 
            background: linear-gradient(135deg, #9D84B7, #5B6FA8, #2C3E7C);
            color: white; 
        }
        th { padding: 15px; text-align: right; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        .rank-badge {
            display: inline-block;
            min-width: 40px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
        }
        .rank-1 { background: #ffd700; color: #333; }
        .rank-2 { background: #c0c0c0; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #e0e0e0; color: #666; }
        .points-badge {
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 13px;
            white-space: nowrap;
            display: inline-block;
        }

        /* ========== Mobile Responsive ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                max-width: 100%;
            }
            .header {
                padding: 15px;
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            .header h1 {
                font-size: 18px;
            }
            .header-right {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .admin-badge, .logout-btn {
                width: 100%;
                font-size: 14px;
                padding: 10px 15px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .stat-card {
                padding: 20px;
            }
            .stat-card .number {
                font-size: 28px;
            }
            .table-card {
                padding: 15px;
                overflow-x: auto;
            }
            .table-card h2 {
                font-size: 18px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px 6px;
            }
            .rank-badge {
                font-size: 11px;
                padding: 3px 7px;
                min-width: 28px;
            }
            .points-badge {
                font-size: 12px;
                padding: 5px 10px;
                white-space: nowrap;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }
            .stat-card .number {
                font-size: 24px;
            }
            .stat-card h3 {
                font-size: 12px;
            }
            table {
                font-size: 11px;
            }
            th, td {
                padding: 6px 4px;
            }
            .points-badge {
                font-size: 11px;
                padding: 4px 8px;
            }
            /* Hide category and date columns on very small screens */
            table th:nth-child(3),
            table td:nth-child(3),
            table th:nth-child(7),
            table td:nth-child(7) {
                display: none;
            }
        }
        /* ========== Modal ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 700px;
            margin: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        .modal-header h2 {
            color: #667eea;
            font-size: 20px;
        }
        .close-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .summary-card h4 {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .summary-card .val {
            color: white;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .summary-card .icon {
            font-size: 24px;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        .summary-card.total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .summary-card.days {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .summary-card.streak {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .progress-table thead {
            background: #667eea;
            color: white;
        }
        .progress-table th {
            padding: 10px;
            text-align: right;
        }
        .progress-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }
        .progress-table tr:hover {
            background: #f9f9f9;
        }
        .check { color: #4caf50; font-weight: bold; }
        .cross { color: #ccc; }
        .day-points {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
        }
        .no-record {
            color: #f44336;
            font-size: 12px;
        }
        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 2px;
        }
        .delete-btn:hover {
            background: #d32f2f;
        }
        .reset-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 2px;
        }
        .reset-btn:hover {
            background: #f57c00;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .search-input::placeholder {
            color: #999;
        }
        @media (max-width: 480px) {
            .modal { padding: 15px; }
            .modal-header h2 { font-size: 16px; }
            .progress-summary { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .summary-card { padding: 10px; }
            .summary-card .val { font-size: 18px; }
            .progress-table { font-size: 12px; }
            .progress-table th, .progress-table td { padding: 7px 5px; }
        }
    </style>
</head>
<body>
    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                <button class="close-btn" onclick="closeModalBtn()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div class="progress-summary">
                <div class="summary-card total">
                    <div class="icon">â­</div>
                    <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</h4>
                    <div class="val" id="modalTotal">0</div>
                </div>
                <div class="summary-card days">
                    <div class="icon">ğŸ“…</div>
                    <h4>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</h4>
                    <div class="val" id="modalDays">0</div>
                </div>
                <div class="summary-card streak">
                    <div class="icon">ğŸ”¥</div>
                    <h4>Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø©</h4>
                    <div class="val" id="modalStreak">0</div>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table class="progress-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø³Ù†Ø© Ø§Ù„ÙØ¬Ø±</th>
                            <th>Ø¬Ù…Ø§Ø¹Ø©</th>
                            <th>ÙÙŠ ÙˆÙ‚ØªÙ‡Ø§</th>
                            <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                        </tr>
                    </thead>
                    <tbody id="progressTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ ÙØ±Ø³Ø§Ù† Ø§Ù„ÙØ¬Ø± - Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
            <div class="header-right">
                <span class="admin-badge">Ù…Ø´Ø±Ù</span>
                <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
                <div class="number" id="totalPoints">0</div>
            </div>
            <div class="stat-card">
                <h3>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
                <div class="number" id="avgPoints">0</div>
            </div>
        </div>
        <div class="search-box">
            <input type="text" 
                   id="searchInput" 
                   class="search-input" 
                   placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨... (Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)"
                   onkeyup="filterStudents()">
        </div>
        <div class="table-card">
            <h2>ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„ÙØ¦Ø©</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="studentsTable">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 30px;">
                            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ Ù‡Ø¬Ø±ÙŠ
        function toHijri(date) {
            // Ø¨Ø¯Ø§ÙŠØ© Ø±Ù…Ø¶Ø§Ù† 1446: ÙØ¨Ø±Ø§ÙŠØ± 18ØŒ 2026 (Ø±Ù…Ø¶Ø§Ù† 1)
            const ramadanStart = new Date('2026-02-18');
            const currentDate = new Date(date);
            currentDate.setHours(0, 0, 0, 0);
            ramadanStart.setHours(0, 0, 0, 0);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…
            const diffTime = currentDate - ramadanStart;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Ø¥Ø°Ø§ Ù‚Ø¨Ù„ Ø±Ù…Ø¶Ø§Ù†
            if (diffDays < 0) {
                // Ø´Ø¹Ø¨Ø§Ù† (30 ÙŠÙˆÙ…)
                const shabbanDay = 30 + diffDays + 1;
                return { day: shabbanDay > 0 ? shabbanDay : 1, month: 8, year: 1446 };
            }
            
            // Ø¥Ø°Ø§ ÙÙŠ Ø±Ù…Ø¶Ø§Ù† (30 ÙŠÙˆÙ…)
            if (diffDays < 30) {
                return { day: diffDays + 1, month: 9, year: 1446 };
            }
            
            // Ø¨Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† = Ø´ÙˆØ§Ù„
            const shawwalDay = diffDays - 29;
            return { day: shawwalDay, month: 10, year: 1446 };
        }

        function hijriMonthName(month) {
            const months = [
                'Ù…Ø­Ø±Ù…', 'ØµÙØ±', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ',
                'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©', 'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†',
                'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©'
            ];
            return months[month - 1];
        }

        function getHijriLabel(date) {
            const hijri = toHijri(date);
            return `${hijriMonthName(hijri.month)} ${hijri.day}`;
        }

        // Store all students for filtering
        let allStudents = [];

        async function loadStudents() {
            try {
                const response = await fetch('/api/admin/students');
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const students = await response.json();
                allStudents = students; // Store for filtering
                
                document.getElementById('totalStudents').textContent = students.length;
                const totalPoints = students.reduce((sum, s) => sum + parseInt(s.total_points || 0), 0);
                document.getElementById('totalPoints').textContent = totalPoints;
                const avgPoints = students.length > 0 ? Math.round(totalPoints / students.length) : 0;
                document.getElementById('avgPoints').textContent = avgPoints;
                
                renderStudents(students);
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function renderStudents(students) {
            const tbody = document.getElementById('studentsTable');
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 30px; color: #999;">
                            Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„Ø¨Ø­Ø«
                        </td>
                    </tr>
                `;
                return;
            }
            tbody.innerHTML = students.map(student => {
                const rankClass = student.rank === 1 ? 'rank-1' : 
                                 student.rank === 2 ? 'rank-2' : 
                                 student.rank === 3 ? 'rank-3' : 'rank-other';
                const date = new Date(student.created_at);
                const formattedDate = date.toLocaleDateString('ar-BH');
                const categoryBadge = student.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const points = parseInt(student.total_points || 0);
                const pointsText = points === 0 ? '0 Ù†Ù‚Ø§Ø·' :
                                  points === 1 ? '1 Ù†Ù‚Ø·Ø©' :
                                  points === 2 ? '2 Ù†Ù‚Ø·ØªØ§Ù†' :
                                  `${points} Ù†Ù‚Ø§Ø·`;
                return `
                    <tr>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;"><span class="rank-badge ${rankClass}">#${student.rank}</span></td>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;"><strong>${student.full_name}</strong></td>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;">${categoryBadge}</td>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;">${student.username}</td>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;"><span class="points-badge">${pointsText}</span></td>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;">${student.days_count} ÙŠÙˆÙ…</td>
                        <td onclick="openStudent(${student.id}, '${student.full_name}')" style="cursor:pointer;">${formattedDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="reset-btn" onclick="resetPassword(${student.id}, '${student.full_name}', '${student.username}')">ğŸ”‘</button>
                                <button class="delete-btn" onclick="deleteUser(${student.id}, '${student.full_name}')">ğŸ—‘ï¸</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function openStudent(id, name) {
            try {
                const response = await fetch(`/api/admin/student/${id}/progress`);
                if (!response.ok) return;
                const data = await response.json();

                document.getElementById('modalTitle').textContent = `ğŸ“Š ØªÙ‚Ø¯Ù… ${name}`;

                const records = data.records;
                const totalPoints = records.reduce((s, r) => s + parseInt(r.total_points || 0), 0);
                
                // Ø­Ø³Ø§Ø¨ Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ù…ØªÙˆØ§ØµÙ„Ø©
                let maxStreak = 0;
                let currentStreak = 0;
                
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
                const sortedRecords = [...records].sort((a, b) => 
                    new Date(a.prayer_date) - new Date(b.prayer_date)
                );
                
                for (let i = 0; i < sortedRecords.length; i++) {
                    currentStreak++;
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙÙŠ ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØªØ§Ù„ÙŠ
                    if (i < sortedRecords.length - 1) {
                        const currentDate = new Date(sortedRecords[i].prayer_date);
                        const nextDate = new Date(sortedRecords[i + 1].prayer_date);
                        const diffDays = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
                        
                        if (diffDays > 1) {
                            maxStreak = Math.max(maxStreak, currentStreak);
                            currentStreak = 0;
                        }
                    }
                }
                maxStreak = Math.max(maxStreak, currentStreak);

                document.getElementById('modalTotal').textContent = totalPoints;
                document.getElementById('modalDays').textContent = records.length;
                document.getElementById('modalStreak').textContent = maxStreak;


                const months = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
                                 'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];

                // Ø¨Ù†Ø§Ø¡ map Ù„Ù„Ø³Ø¬Ù„Ø§Øª
                const recordMap = {};
                records.forEach(r => { recordMap[r.prayer_date] = r; });

                // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
                const todayLocal = new Date();
                const todayStr = todayLocal.getFullYear() + '-' +
                    String(todayLocal.getMonth() + 1).padStart(2, '0') + '-' +
                    String(todayLocal.getDate()).padStart(2, '0');

                let startStr;
                if (records.length > 0) {
                    startStr = records[0].prayer_date;
                } else {
                    startStr = todayStr;
                }

                // ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…
                let rows = '';
                let current = new Date(startStr + 'T00:00:00');
                const end = new Date(todayStr + 'T00:00:00');

                while (current <= end) {
                    const y = current.getFullYear();
                    const mo = String(current.getMonth() + 1).padStart(2, '0');
                    const d = String(current.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${mo}-${d}`;
                    const gregorianLabel = `${months[current.getMonth()]} ${current.getDate()}`;
                    const hijriLabel = getHijriLabel(current);
                    const fullLabel = `${gregorianLabel} - ${hijriLabel}`;
                    const rec = recordMap[dateStr];

                    if (rec) {
                        const pts = rec.total_points;
                        const ptsText = pts === 0 ? '0 Ù†Ù‚Ø§Ø·' :
                                       pts === 1 ? '1 Ù†Ù‚Ø·Ø©' :
                                       pts === 2 ? '2 Ù†Ù‚Ø·ØªØ§Ù†' :
                                       `${pts} Ù†Ù‚Ø§Ø·`;
                        rows += `
                            <tr>
                                <td>${fullLabel}</td>
                                <td>${rec.sunnah_fajr ? '<span class="check">âœ”</span>' : '<span class="cross">âœ—</span>'}</td>
                                <td>${rec.fajr_jamaah ? '<span class="check">âœ”</span>' : '<span class="cross">âœ—</span>'}</td>
                                <td>${rec.fajr_ontime ? '<span class="check">âœ”</span>' : '<span class="cross">âœ—</span>'}</td>
                                <td><span class="day-points">${ptsText}</span></td>
                            </tr>`;
                    } else {
                        rows += `
                            <tr>
                                <td>${fullLabel}</td>
                                <td colspan="4" style="text-align:center;" class="no-record">Ù„Ù… ÙŠØ³Ø¬Ù„</td>
                            </tr>`;
                    }

                    current.setDate(current.getDate() + 1);
                }

                document.getElementById('progressTableBody').innerHTML = rows || 
                    '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';

                document.getElementById('modalOverlay').classList.add('open');

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function closeModal(e) {
            if (e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('open');
            }
        }

        function closeModalBtn() {
            document.getElementById('modalOverlay').classList.remove('open');
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderStudents(allStudents);
                return;
            }
            
            const filtered = allStudents.filter(student => {
                const fullName = student.full_name.toLowerCase();
                const username = student.username.toLowerCase();
                const category = (student.category || '').toLowerCase();
                
                return fullName.includes(searchTerm) || 
                       username.includes(searchTerm) ||
                       category.includes(searchTerm);
            });
            
            renderStudents(filtered);
        }

        async function resetPassword(id, name, username) {
            if (!confirm(`ğŸ”‘ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø·Ø§Ù„Ø¨ "${name}"ØŸ\n\nØ³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/reset-password/${id}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    alert(`âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${data.fullName}\nğŸ” Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.username}\nğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${data.newPassword}\n\nâš ï¸ Ø§Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ£Ø¹Ø·Ù‡Ø§ Ù„Ù„Ø·Ø§Ù„Ø¨!`);
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†: ' + data.error);
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
            }
        }

        async function deleteUser(id, name) {
            if (!confirm(`âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${name}"ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\n- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨\n- Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/user/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
                    loadStudents(); // Reload table
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + data.error);
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
            }
        }

        function closeModal(e) {
            if (e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('open');
            }
        }

        function closeModalBtn() {
            document.getElementById('modalOverlay').classList.remove('open');
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login.html';
        }
        loadStudents();
        setInterval(loadStudents, 30000);
    </script>
</body>
</html>